<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>C IDE + Online Compiler</title>

  <style>
    body {
      margin: 0; padding: 0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      height: 100vh; display: flex; flex-direction: column;
      background: #0b1020; color: #e5e7eb;
    }
    header {
      padding: 0.6rem 1rem;
      display: flex; align-items: center; gap: 0.6rem;
      border-bottom: 1px solid #1f2937;
      background: #0f172a;
    }
    header h1 { font-size: 1rem; margin: 0; font-weight: 600; }
    button {
      padding: 0.35rem 0.8rem; border-radius: 999px;
      border: 1px solid #334155; background: #111827; color: #e5e7eb;
      cursor: pointer; font-size: 0.9rem;
    }
    button:hover { background: #1f2937; }
    button:disabled { opacity: 0.5; cursor: default; }

    /* Tab system styles */
    .tabs-container {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #0f172a;
      border-bottom: 1px solid #1f2937;
      overflow-x: auto;
    }
    .tab {
      display: flex; align-items: center; gap: 0.5rem;
      padding: 0.4rem 0.8rem;
      background: #1f2937;
      border-radius: 6px 6px 0 0;
      cursor: pointer;
      border: 1px solid #334155;
      white-space: nowrap;
      position: relative;
    }
    .tab:hover { background: #2d3748; }
    .tab.active {
      background: #0b1020;
      border-bottom-color: #0b1020;
    }
    .tab-name {
      font-size: 0.85rem;
      min-width: 60px;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tab-name.editing {
      min-width: 100px;
      max-width: 200px;
    }
    .tab-name-input {
      background: #111827;
      border: 1px solid #3b82f6;
      border-radius: 3px;
      color: #e5e7eb;
      padding: 2px 4px;
      font-size: 0.85rem;
      font-family: inherit;
      width: 120px;
    }
    .tab-name-input:focus {
      outline: none;
    }
    .tab-close {
      color: #9ca3af;
      font-size: 1.1rem;
      line-height: 1;
      padding: 0 0.3rem;
      border-radius: 3px;
    }
    .tab-close:hover {
      color: #f87171;
      background: #1f2937;
    }
    .tab-add {
      padding: 0.4rem 0.8rem;
      background: #334155;
      border-radius: 6px;
      border: 1px solid #475569;
      font-size: 1rem;
      line-height: 1;
    }
    .tab-add:hover { background: #475569; }

    /* Save button near tabs */
    .save-btn {
      margin-left: 0.5rem;
      padding: 0.4rem 0.9rem;
      background: #166534;
      border-color: #15803d;
    }
    .save-btn:hover { background: #15803d; }
    .save-btn:disabled {
      background: #1f2937;
      border-color: #334155;
    }

    .main {
      flex: 1; display: grid;
      grid-template-columns: 1.2fr 0.8fr;
      min-height: 0;
    }
    #editor { height: 100%; }
    .right {
      border-left: 1px solid #1f2937;
      display: flex; flex-direction: column; min-height: 0;
    }
    .panel {
      padding: 0.6rem 0.8rem; border-bottom: 1px solid #1f2937;
      background: #0b1224; font-size: 0.9rem;
    }
    #status { color: #9ca3af; }
    #output {
      flex: 1; padding: 0.8rem; margin: 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size: 0.85rem; white-space: pre-wrap; overflow: auto;
      background: #050814;
    }
    .success { color: #4ade80; }
    .error { color: #fca5a5; }

    footer {
      padding: 0.4rem 0.8rem; font-size: 0.8rem; color: #9ca3af;
      border-top: 1px solid #1f2937; background: #0f172a;
    }
  </style>

  <!-- Monaco loader (AMD) -->
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs/loader.js"></script>
</head>

<body>
  <header>
    <h1>C IDE (Monaco) + Wandbox</h1>
    <button id="runBtn" disabled>â–¶ Compile & Run</button>
    <button id="exampleBtn">Load Example</button>
    <span id="status">Loading editorâ€¦</span>
  </header>

  <div class="tabs-container">
    <div class="tab active" data-tab-id="0">
      <span class="tab-name">main.c</span>
      <span class="tab-close" onclick="closeTab(0, event)">Ã—</span>
    </div>
    <button class="tab-add" onclick="addNewTab()">+</button>
    <button class="save-btn" id="saveBtn" disabled>ðŸ’¾ Save</button>
  </div>

  <div class="main">
    <div id="editor"></div>

    <div class="right">
      <div class="panel">Output</div>
      <pre id="output">Click "Compile & Run" to execute your code...</pre>
    </div>
  </div>

  <footer>
    Wandbox API â€¢ Multi-tab editing â€¢ Double-click tab to rename â€¢ Auto-save to local folder<br>
    ðŸ“š Documentation: <a href="MultiTab-Feature-Documentation-v1.html" target="_blank" style="color: #569cd6;">v1 è¯¦ç»†è®²è§£</a> |
    <a href="MultiTab-Feature-Documentation-v2.html" target="_blank" style="color: #4ec9b0;">v2 æ”¹è¿›è¯¦è§£</a> |
    <a href="CCompiler-Comparison.html" target="_blank" style="color: #dcdcaa;">æ–¹æ¡ˆå¯¹æ¯”</a>
  </footer>

<script>
/* ==========================================================
   Tab Management System
========================================================== */
let tabs = [
  {
    id: 0,
    name: 'main.c',
    content: `#include <stdio.h>

int main() {
  printf("Hello from C!\\n");
  return 0;
}
`
  }
];
let currentTabId = 0;
let nextTabId = 1;
let editor = null;
let editingTabId = null;

function renderTabs() {
  const container = document.querySelector('.tabs-container');
  const addButton = container.querySelector('.tab-add');
  const saveButton = container.querySelector('.save-btn');

  // Remove all tabs
  const tabElements = container.querySelectorAll('.tab');
  tabElements.forEach(el => el.remove());

  // Create tab elements
  tabs.forEach(tab => {
    const tabEl = document.createElement('div');
    tabEl.className = 'tab' + (tab.id === currentTabId ? ' active' : '');
    tabEl.dataset.tabId = tab.id;

    // Check if this tab is being edited
    if (tab.id === editingTabId) {
      tabEl.innerHTML = `
        <input type="text" class="tab-name-input" value="${tab.name}"
               onblur="finishRenaming(${tab.id})"
               onkeydown="handleRenameKeydown(event, ${tab.id})"
               id="rename-input-${tab.id}">
        <span class="tab-close" onclick="closeTab(${tab.id}, event)">Ã—</span>
      `;
    } else {
      tabEl.innerHTML = `
        <span class="tab-name" ondblclick="startRenaming(${tab.id}, event)">${tab.name}</span>
        <span class="tab-close" onclick="closeTab(${tab.id}, event)">Ã—</span>
      `;
    }

    tabEl.onclick = (e) => {
      if (!e.target.classList.contains('tab-close') &&
          !e.target.classList.contains('tab-name-input')) {
        switchTab(tab.id);
      }
    };
    container.insertBefore(tabEl, addButton);
  });

  // Focus the rename input if editing
  if (editingTabId !== null) {
    setTimeout(() => {
      const input = document.getElementById(`rename-input-${editingTabId}`);
      if (input) {
        input.focus();
        input.select();
      }
    }, 0);
  }
}

function startRenaming(tabId, event) {
  event.stopPropagation();
  editingTabId = tabId;
  renderTabs();
}

function finishRenaming(tabId) {
  const input = document.getElementById(`rename-input-${tabId}`);
  if (input) {
    const newName = input.value.trim();
    const tab = tabs.find(t => t.id === tabId);
    if (tab && newName) {
      tab.name = newName;
    }
  }
  editingTabId = null;
  renderTabs();
}

function handleRenameKeydown(event, tabId) {
  if (event.key === 'Enter') {
    event.preventDefault();
    finishRenaming(tabId);
  } else if (event.key === 'Escape') {
    event.preventDefault();
    editingTabId = null;
    renderTabs();
  }
}

function switchTab(tabId) {
  // Save current tab content
  if (editor) {
    const currentTab = tabs.find(t => t.id === currentTabId);
    if (currentTab) {
      currentTab.content = editor.getValue();
    }
  }

  // Switch to new tab
  currentTabId = tabId;
  const newTab = tabs.find(t => t.id === tabId);
  if (newTab && editor) {
    editor.setValue(newTab.content);
  }

  renderTabs();
}

function addNewTab() {
  const newTab = {
    id: nextTabId++,
    name: `file${nextTabId}.c`,
    content: `#include <stdio.h>

int main() {
  // Your code here
  return 0;
}
`
  };
  tabs.push(newTab);
  switchTab(newTab.id);
}

function closeTab(tabId, event) {
  event.stopPropagation();

  if (tabs.length === 1) {
    alert('Cannot close the last tab!');
    return;
  }

  const tabIndex = tabs.findIndex(t => t.id === tabId);
  tabs.splice(tabIndex, 1);

  // If closing current tab, switch to another
  if (tabId === currentTabId) {
    const newCurrentTab = tabs[Math.max(0, tabIndex - 1)];
    currentTabId = newCurrentTab.id;
    if (editor) {
      editor.setValue(newCurrentTab.content);
    }
  }

  renderTabs();
}

/* ==========================================================
   Monaco Editor setup
========================================================== */
require.config({
  paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.52.0/min/vs" }
});

require(["vs/editor/editor.main"], () => {
  editor = monaco.editor.create(document.getElementById("editor"), {
    value: tabs[0].content,
    language: "c",
    theme: "vs-dark",
    fontSize: 14,
    minimap: { enabled: false },
    automaticLayout: true
  });

  runBtn.disabled = false;
  saveBtn.disabled = false;
  status("Editor ready. Press Compile & Run.");
});

/* ==========================================================
   UI wiring
========================================================== */
const runBtn = document.getElementById("runBtn");
const saveBtn = document.getElementById("saveBtn");
const exampleBtn = document.getElementById("exampleBtn");
const outputEl = document.getElementById("output");
const statusEl = document.getElementById("status");

function status(msg){ statusEl.textContent = msg; }
function out(msg="", className=""){
  outputEl.textContent = msg;
  outputEl.className = className;
}

/* ==========================================================
   Save to local folder
========================================================== */
saveBtn.addEventListener("click", async () => {
  if (!editor) return;

  const currentTab = tabs.find(t => t.id === currentTabId);
  const filename = currentTab.name;
  const content = editor.getValue();

  // Update tab content
  currentTab.content = content;

  status("Saving...");
  saveBtn.disabled = true;

  try {
    const response = await fetch('/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        filename: filename,
        content: content
      })
    });

    const result = await response.json();

    if (result.success) {
      status(`Saved: ${filename}`);
      setTimeout(() => status("Ready."), 2000);
    } else {
      status(`Save failed: ${result.error}`);
    }
  } catch (e) {
    status(`Save error: ${e.message}`);
  } finally {
    saveBtn.disabled = false;
  }
});

/* ==========================================================
   Run button -> Wandbox API
========================================================== */
runBtn.addEventListener("click", async () => {
  out("Compiling and running...");
  status("Running...");
  runBtn.disabled = true;

  const code = editor.getValue();

  try {
    const response = await fetch('https://wandbox.org/api/compile.json', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        compiler: 'gcc-head',
        code: code,
        options: 'warning,gnu++1y',
        stdin: '',
        'compiler-option-raw': '-lm'
      })
    });

    const result = await response.json();

    let outputText = '';
    if (result.program_output) {
      outputText += 'âœ… Output:\n' + result.program_output;
    }
    if (result.program_error) {
      outputText += '\nâš ï¸ Errors:\n' + result.program_error;
    }
    if (result.compiler_error) {
      outputText += '\nâŒ Compile Error:\n' + result.compiler_error;
    }

    out(outputText || 'âœ… Program completed successfully (no output)',
        result.compiler_error ? 'error' : 'success');
    status(result.compiler_error ? "Compile error." : "Run complete.");

  } catch (e) {
    out('âŒ Error: ' + (e.message || String(e)), 'error');
    status("Error.");
  } finally {
    runBtn.disabled = false;
  }
});

/* ==========================================================
   Example loader
========================================================== */
exampleBtn.addEventListener("click", () => {
  const ex = `#include <stdio.h>
#include <math.h>

int main() {
  printf("Hello from C!\\n\\n");

  for (int i = 0; i < 5; i++) {
    printf("sin(%d) = %.4f\\n", i, sin(i));
  }

  return 0;
}`;
  editor.setValue(ex);
});
</script>

</body>
</html>
